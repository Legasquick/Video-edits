<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Feedback Pro 2.2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            /* Palette */
            --bg-main: #0f172a;       
            --bg-secondary: #1e293b;  
            --bg-input: #334155;      
            --bg-hover: #475569;
            
            --primary: #6366f1;       
            --primary-hover: #4f46e5;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --border: #334155;
            --border-focus: #818cf8;
            
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            
            --radius: 12px;
            --radius-sm: 6px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            font-size: 14px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* --- Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            background-color: var(--bg-main);
        }

        /* --- Header --- */
        .header {
            grid-column: 1 / -1;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 10;
        }

        .brand {
            display: flex; align-items: center; gap: 12px;
            font-weight: 600; font-size: 18px; color: var(--text-main);
        }
        .brand span { background: linear-gradient(135deg, #6366f1, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .project-input {
            background: var(--bg-main); border: 1px solid var(--border);
            color: var(--text-main); padding: 8px 16px; border-radius: var(--radius-sm); 
            width: 320px; transition: all 0.2s; font-family: inherit;
        }
        .project-input:focus { border-color: var(--border-focus); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        /* --- Left Panel (Video & Editor) --- */
        .left-panel {
            padding: 24px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 16px;
        }

        /* Video Area */
        .video-wrapper {
            background: #000;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: height 0.2s ease;
        }

        .video-container {
            position: relative;
            flex: 1;
            display: flex; align-items: center; justify-content: center;
            background: #000;
            min-height: 200px;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            display: block; 
            cursor: pointer; 
        }

        /* Timeline Bar */
        .video-timeline-bar {
            background: var(--bg-secondary);
            padding: 8px 16px;
            display: flex; align-items: center; gap: 12px;
            border-top: 1px solid var(--border);
        }

        .time-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--text-muted);
            white-space: nowrap;
            min-width: 90px;
            text-align: right;
        }

        /* Range Slider Styling (Seek Bar) */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 16px;
        }
        input[type=range]:focus { outline: none; border: none; box-shadow: none; }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: var(--bg-input); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 14px; width: 14px; border-radius: 50%;
            background: var(--primary); cursor: pointer;
            -webkit-appearance: none; margin-top: -5px;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); background: var(--primary-hover); }

        /* Controls & Size Slider */
        .controls-bar {
            display: flex; gap: 12px; align-items: center;
            background: var(--bg-secondary); padding: 10px 16px;
            border-radius: var(--radius); border: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .size-control {
            display: flex; align-items: center; gap: 8px; margin-left: auto;
            font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;
        }
        .size-slider { width: 80px !important; }

        .upload-zone {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; color: var(--text-muted); z-index: 5;
        }
        .upload-btn {
            background: var(--primary); color: white; padding: 10px 24px; 
            border-radius: var(--radius-sm); cursor: pointer; border: none; 
            font-weight: 500; transition: 0.2s;
        }
        .upload-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* Form Area */
        .editor-card {
            background-color: var(--bg-secondary);
            padding: 24px; border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        /* Segmented Control Tabs */
        .type-tabs { 
            display: flex; background: var(--bg-main); padding: 4px; 
            border-radius: var(--radius-sm); margin-bottom: 20px; 
            width: fit-content; border: 1px solid var(--border);
        }
        .type-tab {
            padding: 6px 20px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;
            color: var(--text-muted); transition: 0.2s; user-select: none;
        }
        .type-tab:hover { color: var(--text-main); }
        .type-tab.active { background: var(--bg-input); color: var(--text-main); shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .type-tab.active-general { background: var(--bg-input); color: var(--text-main); }

        /* Inputs */
        .form-grid { display: grid; gap: 16px; }
        .row { display: flex; gap: 16px; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 6px; }

        label { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .input-wrapper { position: relative; }
        
        input[type="text"], textarea {
            width: 100%; background: var(--bg-input); border: 1px solid transparent;
            color: white; padding: 10px 12px; border-radius: var(--radius-sm); 
            font-size: 14px; font-family: inherit; transition: 0.2s;
        }
        input[type="text"]:focus, textarea:focus { 
            border-color: var(--primary); background: var(--bg-main);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

        .time-input-group input { padding-right: 40px; font-family: 'JetBrains Mono', monospace; }
        .time-capture-btn {
            position: absolute; right: 4px; top: 4px; bottom: 4px;
            width: 32px; border: none; border-radius: 4px;
            background: var(--bg-secondary); color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: 0.2s;
        }
        .time-capture-btn:hover { background: var(--primary); color: white; }

        /* Action Buttons */
        .btn {
            padding: 10px 20px; border: none; border-radius: var(--radius-sm); 
            cursor: pointer; font-weight: 600; font-size: 14px; 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s ease;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-secondary { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); color: white; border-color: var(--text-muted); }
        .btn-sm { padding: 6px 12px; font-size: 12px; height: 32px; }

        /* --- Right Panel (List) --- */
        .right-panel {
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
        }
        .panel-title { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .badge-count { background: var(--bg-input); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }

        .edits-list { 
            flex: 1; padding: 16px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 12px;
        }

        .edit-card {
            background: var(--bg-main); border: 1px solid var(--border); 
            border-radius: var(--radius-sm); padding: 14px;
            position: relative; transition: 0.2s; cursor: pointer;
            border-left: 3px solid transparent;
        }
        .edit-card:hover { transform: translateX(4px); border-color: var(--border-focus); }
        .edit-card.type-cut { border-left-color: var(--primary); }
        .edit-card.type-general { border-left-color: var(--warning); }
        .edit-card.editing { border-color: var(--warning); box-shadow: 0 0 0 1px var(--warning) inset; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .timestamp-badge { 
            background: rgba(99, 102, 241, 0.15); color: #a5b4fc; 
            padding: 4px 8px; border-radius: 4px; 
            font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: 500;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .general-badge {
            background: rgba(245, 158, 11, 0.15); color: #fcd34d;
            padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
        }
        .card-context { 
            font-size: 12px; color: var(--text-muted); margin-bottom: 8px; 
            padding: 8px; background: var(--bg-secondary); border-radius: 4px; 
            border-left: 2px solid var(--bg-input); font-style: italic;
        }
        .card-text { font-size: 14px; line-height: 1.5; color: var(--text-main); white-space: pre-wrap; }
        
        .card-actions { 
            display: flex; gap: 4px; opacity: 0; transition: 0.2s; 
            position: absolute; top: 10px; right: 10px;
            background: var(--bg-main); padding-left: 10px;
        }
        .edit-card:hover .card-actions { opacity: 1; }
        
        .icon-btn {
            width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border);
            background: var(--bg-secondary); color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .icon-btn:hover { color: var(--text-main); border-color: var(--text-muted); }
        .icon-btn.danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .export-bar { padding: 16px; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .export-bar button { flex: 1; }
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 0.8; } 100% { opacity: 0.5; } }
        .empty-state { text-align: center; color: var(--text-muted); margin-top: 60px; animation: pulse 3s infinite; }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
            .right-panel { border-left: none; border-top: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="brand"><span>üìπ</span> Video Logic Pro</div>
        <input type="text" id="projectName" class="project-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –í–∏–¥–µ–æ">
    </header>

    <div class="left-panel">
        <!-- Wrapper controls the size -->
        <div class="video-wrapper" id="videoWrapper" style="height: 480px;">
            <div class="video-container">
                <video id="videoPlayer" class="hidden"></video>
                <div id="uploadPlaceholder" class="upload-zone">
                    <div style="font-size: 40px; opacity: 0.5">üìÇ</div>
                    <button class="upload-btn" onclick="document.getElementById('videoUpload').click()">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤–∏–¥–µ–æ</button>
                    <input type="file" id="videoUpload" accept="video/*" style="display:none">
                    <span style="font-size: 12px; opacity: 0.5">MP4, MOV, WEBM</span>
                </div>
            </div>
            
            <!-- Timeline (Seek Bar) -->
            <div class="video-timeline-bar hidden" id="timelineBar">
                <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1">
                <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
            </div>
        </div>

        <!-- Controls (Speed + Size) -->
        <div class="controls-bar hidden" id="controls">
            <button class="btn btn-secondary btn-sm" onclick="changeSpeed(1)">1x</button>
            <button class="btn btn-secondary btn-sm" onclick="changeSpeed(1.5)">1.5x</button>
            <button class="btn btn-secondary btn-sm" onclick="changeSpeed(2)">2x</button>
            
            <div class="size-control">
                üîç –†–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ
                <input type="range" class="size-slider" id="sizeSlider" min="200" max="800" value="480" step="10" oninput="resizeVideo(this.value)">
            </div>
        </div>

        <div class="editor-card">
            <div class="type-tabs">
                <div class="type-tab active" id="tab-cut" onclick="setEditType('cut')">‚úÇÔ∏è –ü–æ —Ç–∞–π–º–∫–æ–¥—É</div>
                <div class="type-tab" id="tab-general" onclick="setEditType('general')">üìÑ –û–±—â–∞—è –ø—Ä–∞–≤–∫–∞</div>
            </div>
            <div class="form-grid">
                <div class="row" id="timeFields">
                    <div class="col">
                        <label>–ù–∞—á–∞–ª–æ (In)</label>
                        <div class="input-wrapper time-input-group">
                            <input type="text" id="timeStart" placeholder="00:00:00" onfocus="pauseVideo()">
                            <button class="time-capture-btn" onclick="captureTime('timeStart')" title="–í—Å—Ç–∞–≤–∏—Ç—å (I)">‚è±</button>
                        </div>
                    </div>
                    <div class="col">
                        <label>–ö–æ–Ω–µ—Ü (Out)</label>
                        <div class="input-wrapper time-input-group">
                            <input type="text" id="timeEnd" placeholder="00:00:00" onfocus="pauseVideo()">
                            <button class="time-capture-btn" onclick="captureTime('timeEnd')" title="–í—Å—Ç–∞–≤–∏—Ç—å (O)">‚è±</button>
                        </div>
                    </div>
                </div>
                <div class="row" id="wordsFields">
                    <div class="col"><label>–ù–∞—á–∞–ª–æ (—Å–ª–æ–≤–∞)</label><input type="text" id="firstWords"></div>
                    <div class="col"><label>–ö–æ–Ω–µ—Ü (—Å–ª–æ–≤–∞)</label><input type="text" id="lastWords"></div>
                </div>
                <div class="col">
                    <label id="actionLabel">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="action" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" onkeydown="handleEnter(event)"></textarea>
                </div>
                <div class="row" style="margin-top: 8px;">
                    <button id="addBtn" class="btn btn-primary" style="flex: 1" onclick="addEdit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    <button id="cancelBtn" class="btn btn-secondary hidden" onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="panel-header">
            <div class="panel-title">–°–ø–∏—Å–æ–∫ <span class="badge-count" id="count">0</span></div>
            <button class="icon-btn danger" onclick="clearAll()">üóë</button>
        </div>
        <div class="edits-list" id="editsList"><div class="empty-state">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div></div>
        <div class="export-bar">
            <button class="btn btn-secondary" onclick="copyToClipboard()">üìã –¢–µ–∫—Å—Ç</button>
            <button class="btn btn-secondary" onclick="exportSRT()">üìÑ SRT</button>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let edits = [];
    let currentType = 'cut'; 
    let editingId = null;
    const player = document.getElementById('videoPlayer');
    const seekBar = document.getElementById('seekBar');
    const timeDisplay = document.getElementById('timeDisplay');
    const videoWrapper = document.getElementById('videoWrapper');
    const STORAGE_KEY = 'videoLogicPro_v5';

    document.addEventListener('DOMContentLoaded', () => {
        loadProject();
        setupVideoHandling();
        setupHotkeys();
    });

    // --- UI Logic ---
    function setEditType(type) {
        currentType = type;
        document.getElementById('tab-cut').classList.toggle('active', type === 'cut');
        document.getElementById('tab-general').classList.toggle('active', type === 'general');
        document.getElementById('tab-general').classList.toggle('active-general', type === 'general');
        
        const isGen = type === 'general';
        document.getElementById('timeFields').classList.toggle('hidden', isGen);
        document.getElementById('wordsFields').classList.toggle('hidden', isGen);
        document.getElementById('action').placeholder = isGen ? "–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" : "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?";
    }

    function resizeVideo(val) {
        videoWrapper.style.height = val + 'px';
    }

    function setupVideoHandling() {
        // Toggle Play/Pause on click
        player.addEventListener('click', () => player.paused ? player.play() : player.pause());

        // Update timeline logic
        player.addEventListener('timeupdate', () => {
            if (!player.duration) return;
            const percent = (player.currentTime / player.duration) * 100;
            seekBar.value = percent;
            timeDisplay.textContent = formatTimeSimple(player.currentTime) + " / " + formatTimeSimple(player.duration);
        });

        // Seek logic
        seekBar.addEventListener('input', () => {
            if (!player.duration) return;
            const time = (seekBar.value / 100) * player.duration;
            player.currentTime = time;
        });

        document.getElementById('videoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                player.src = URL.createObjectURL(file);
                player.classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('timelineBar').classList.remove('hidden');
                if(!document.getElementById('projectName').value) document.getElementById('projectName').value = file.name;
            }
        });
    }

    // --- Time Helpers ---
    function formatTimeSimple(seconds) {
        if (isNaN(seconds)) return "00:00";
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return "00:00:00";
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const parts = timeStr.split(':').map(Number);
        return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
    }

    function captureTime(fieldId) {
        if (!player.src) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ");
        document.getElementById(fieldId).value = formatTime(player.currentTime);
    }

    function changeSpeed(rate) { player.playbackRate = rate; }
    function pauseVideo() { player.pause(); }

    // --- CRUD ---
    function addEdit() {
        const action = document.getElementById('action').value.trim();
        if (!action) return alert("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");

        const editData = {
            id: editingId || Date.now(),
            type: currentType,
            action: action,
            timestamp: Date.now()
        };

        if (currentType === 'cut') {
            const start = document.getElementById('timeStart').value;
            if (!start) return alert("–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è");
            editData.timeStart = start;
            editData.timeEnd = document.getElementById('timeEnd').value;
            editData.firstWords = document.getElementById('firstWords').value;
            editData.lastWords = document.getElementById('lastWords').value;
            editData.seconds = parseTime(start);
        } else {
            editData.seconds = -1;
        }

        if (editingId) {
            const idx = edits.findIndex(e => e.id === editingId);
            edits[idx] = editData;
        } else {
            edits.push(editData);
        }

        edits.sort((a, b) => {
            if (a.type === 'general' && b.type !== 'general') return -1;
            if (a.type !== 'general' && b.type === 'general') return 1;
            return a.seconds - b.seconds;
        });

        saveProject();
        renderEdits();
        resetForm();
    }

    function editItem(id) {
        const item = edits.find(e => e.id === id);
        if (!item) return;
        setEditType(item.type);
        editingId = id;
        document.getElementById('action').value = item.action;
        if (item.type === 'cut') {
            document.getElementById('timeStart').value = item.timeStart;
            document.getElementById('timeEnd').value = item.timeEnd || '';
            document.getElementById('firstWords').value = item.firstWords || '';
            document.getElementById('lastWords').value = item.lastWords || '';
        }
        document.getElementById('addBtn').textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        document.getElementById('cancelBtn').classList.remove('hidden');
    }

    function deleteItem(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            edits = edits.filter(e => e.id !== id);
            if (editingId === id) resetForm();
            saveProject();
            renderEdits();
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('action').value = '';
        document.getElementById('timeStart').value = '';
        document.getElementById('timeEnd').value = '';
        document.getElementById('firstWords').value = '';
        document.getElementById('lastWords').value = '';
        document.getElementById('addBtn').textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å";
        document.getElementById('cancelBtn').classList.add('hidden');
        setEditType('cut');
    }

    function clearAll() {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ?")) {
            edits = [];
            saveProject();
            renderEdits();
        }
    }

    // --- Render ---
    function renderEdits() {
        const list = document.getElementById('editsList');
        document.getElementById('count').textContent = edits.length;
        if (edits.length === 0) {
            list.innerHTML = '<div class="empty-state">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
            return;
        }
        list.innerHTML = edits.map((item) => {
            const isGeneral = item.type === 'general';
            const contextStr = (item.firstWords || item.lastWords) ? 
                `<div class="card-context">${item.firstWords || ''} ... ${item.lastWords || ''}</div>` : '';
            
            const header = isGeneral ? `<span class="general-badge">–û–ë–©–ê–Ø</span>` : 
                `<div class="timestamp-badge">‚è± ${item.timeStart}</div>` + (item.timeEnd ? `<div class="timestamp-badge" style="margin-left:4px">‚ûù ${item.timeEnd}</div>` : '');

            return `<div class="edit-card type-${item.type} ${item.id === editingId ? 'editing' : ''}" 
                     onclick="${!isGeneral ? `jumpTo('${item.timeStart}')` : ''}">
                    <div class="card-header">
                        <div style="display:flex; align-items:center">${header}</div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="icon-btn danger" onclick="event.stopPropagation(); deleteItem(${item.id})">üóë</button>
                        </div>
                    </div>
                    ${contextStr}
                    <div class="card-text">${item.action}</div>
                </div>`;
        }).join('');
    }

    function jumpTo(time) { if(time) { player.currentTime = parseTime(time); player.play(); }}

    // --- Export ---
    function copyToClipboard() {
        const name = document.getElementById('projectName').value;
        let text = name ? `–ü–†–û–ï–ö–¢: ${name}\n\n` : '';
        edits.forEach((e, i) => {
            const prefix = e.type === 'general' ? '‚Ä¢ –û–ë–©–ê–Ø' : `${i+1}. ${e.timeStart}`;
            text += `${prefix}: ${e.action}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
    }

    function exportSRT() {
        let content = '', counter = 1;
        edits.forEach(e => {
            const start = e.type==='general' ? '00:00:00,000' : e.timeStart.replace('.', ',') + (e.timeStart.includes(',')?'':',000');
            const end = e.type==='general' ? '00:00:05,000' : (e.timeEnd ? e.timeEnd.replace('.', ',') : formatTime(parseTime(e.timeStart)+3).replace('.',',')+',000');
            content += `${counter++}\n${start} --> ${end}\n${e.action}\n\n`;
        });
        const blob = new Blob([content], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = (document.getElementById('projectName').value || 'edits') + '.srt';
        link.click();
    }

    // --- Hotkeys ---
    function setupHotkeys() {
        document.addEventListener('keydown', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
            if (e.code === 'Space') { e.preventDefault(); player.paused ? player.play() : player.pause(); }
            if (e.code === 'KeyI') { e.preventDefault(); captureTime('timeStart'); }
            if (e.code === 'KeyO') { e.preventDefault(); captureTime('timeEnd'); }
        });
    }
    function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addEdit(); } }

    function saveProject() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ name: document.getElementById('projectName').value, edits: edits })); }
    function loadProject() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (data) { document.getElementById('projectName').value = data.name || ''; edits = data.edits || []; renderEdits(); }
    }
    document.getElementById('projectName').addEventListener('input', saveProject);
</script>
</body>
</html>
