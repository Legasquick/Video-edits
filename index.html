<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Feedback Pro 2.5 (Smart Inputs)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --bg-main: #0f172a;       
            --bg-secondary: #1e293b;  
            --bg-input: #334155;      
            --bg-hover: #475569;
            --primary: #6366f1;       
            --primary-hover: #4f46e5;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --border-focus: #818cf8;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 12px;
            --radius-sm: 6px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            font-size: 14px;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 1fr 380px; 
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 10;
        }

        .brand { font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .project-input {
            background: var(--bg-main); border: 1px solid var(--border);
            color: var(--text-main); padding: 8px 16px; border-radius: var(--radius-sm); 
            width: 300px; transition: 0.2s;
        }
        .project-input:focus { border-color: var(--border-focus); }

        /* Left Panel */
        .left-panel {
            padding: 20px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 16px;
            background: var(--bg-main);
        }

        /* Video Wrapper */
        .video-wrapper {
            background: #000;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            position: relative;
        }

        .video-container {
            flex: 1; 
            display: flex; align-items: center; justify-content: center;
            background: #000;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            display: block; 
            cursor: pointer; 
            object-fit: contain; 
        }

        /* Video Footer */
        .video-footer {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }

        .timeline-container { display: flex; align-items: center; gap: 12px; width: 100%; }

        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; height: 16px; display: block;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: var(--bg-input); border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 16px; width: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; -webkit-appearance: none; margin-top: -5px; border: 2px solid white;
        }

        .time-display { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-main); min-width: 95px; text-align: right; }

        .controls-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .controls-left { display: flex; gap: 8px; align-items: center; }
        
        .shortcuts-info {
            font-size: 11px; color: var(--text-muted); display: flex; gap: 12px; align-items: center;
            background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.05);
        }
        .key {
            background: var(--bg-input); padding: 2px 6px; border-radius: 4px; 
            font-family: 'JetBrains Mono', monospace; color: var(--text-main); border: 1px solid var(--border); font-weight: bold;
        }

        .size-control { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-left: 15px; }
        .size-slider { width: 80px !important; }

        /* Upload Zone */
        .upload-zone {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; color: var(--text-muted); z-index: 5; background: #0f172a;
        }
        .upload-btn { background: var(--primary); color: white; padding: 12px 24px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 15px; }

        /* Editor Form */
        .editor-card {
            background-color: var(--bg-secondary);
            padding: 20px; border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .type-tabs { display: flex; background: var(--bg-main); padding: 4px; border-radius: var(--radius-sm); margin-bottom: 16px; width: fit-content; border: 1px solid var(--border); }
        .type-tab { padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); user-select: none; }
        .type-tab.active { background: var(--bg-input); color: var(--text-main); }

        .form-grid { display: grid; gap: 12px; }
        .row { display: flex; gap: 12px; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 6px; }

        label { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        
        input[type="text"], textarea {
            width: 100%; background: var(--bg-input); border: 1px solid transparent;
            color: white; padding: 10px; border-radius: var(--radius-sm); font-size: 14px; 
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); background: var(--bg-main); }
        
        .time-input-group { position: relative; }
        .time-capture-btn {
            position: absolute; right: 4px; top: 4px; bottom: 4px; width: 30px;
            border: none; border-radius: 4px; background: var(--bg-secondary); color: var(--text-main); cursor: pointer;
        }
        .time-capture-btn:hover { background: var(--primary); }

        .btn { padding: 10px 20px; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; }
        .btn-secondary { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-sm { padding: 4px 10px; font-size: 11px; height: 28px; }

        /* Right Panel */
        .right-panel {
            background-color: var(--bg-secondary); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.95); }
        .edits-list { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .edit-card {
            background: var(--bg-main); border: 1px solid var(--border); 
            border-radius: var(--radius-sm); padding: 12px; position: relative; cursor: pointer;
            border-left: 3px solid transparent; transition: 0.2s;
        }
        .edit-card:hover { transform: translateX(4px); border-color: var(--border-focus); }
        .edit-card.type-cut { border-left-color: var(--primary); }
        .edit-card.type-general { border-left-color: var(--warning); }
        .edit-card.editing { border-color: var(--warning); }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .timestamp-badge { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-family: monospace; }
        .card-context { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; font-style: italic; background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; }
        .card-actions { display: flex; gap: 4px; opacity: 0; transition: 0.2s; position: absolute; top: 8px; right: 8px; background: var(--bg-main); }
        .edit-card:hover .card-actions { opacity: 1; }
        .icon-btn { width: 22px; height: 22px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .icon-btn:hover { color: var(--text-main); }
        .icon-btn.danger:hover { background: var(--danger); color: white; border-color: var(--danger); }
        
        .export-bar { padding: 12px; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .export-bar button { flex: 1; }
        .hidden { display: none !important; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 3px; }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
            .right-panel { border-left: none; border-top: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="brand"><span>üìπ</span> Video Logic Pro</div>
        <input type="text" id="projectName" class="project-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
    </header>

    <div class="left-panel">
        <div class="video-wrapper" id="videoWrapper" style="height: 60vh;">
            <div class="video-container">
                <video id="videoPlayer" class="hidden"></video>
                <div id="uploadPlaceholder" class="upload-zone">
                    <div style="font-size: 48px; opacity: 0.5">üìÇ</div>
                    <button class="upload-btn" onclick="document.getElementById('videoUpload').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
                    <input type="file" id="videoUpload" accept="video/*" style="display:none">
                </div>
            </div>
            
            <div class="video-footer hidden" id="videoFooter">
                <div class="timeline-container">
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1">
                    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
                </div>

                <div class="controls-row">
                    <div class="controls-left">
                        <button class="btn btn-secondary btn-sm" onclick="togglePlay()">‚èØ Play/Pause</button>
                        <button class="btn btn-secondary btn-sm" onclick="changeSpeed(1)">1x</button>
                        <button class="btn btn-secondary btn-sm" onclick="changeSpeed(1.5)">1.5x</button>
                        <button class="btn btn-secondary btn-sm" onclick="changeSpeed(2)">2x</button>
                        
                        <div class="size-control">
                            üîç –†–∞–∑–º–µ—Ä
                            <input type="range" class="size-slider" id="sizeSlider" min="30" max="90" value="60" oninput="resizeVideo(this.value)">
                        </div>
                    </div>

                    <div class="shortcuts-info">
                        <div><span class="key">Space</span> Play</div>
                        <div><span class="key">I</span> In</div>
                        <div><span class="key">O</span> Out</div>
                        <div><span class="key">Enter</span> Add</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-card">
            <div class="type-tabs">
                <div class="type-tab active" id="tab-cut" onclick="setEditType('cut')">‚úÇÔ∏è –¢–∞–π–º–∫–æ–¥</div>
                <div class="type-tab" id="tab-general" onclick="setEditType('general')">üìÑ –û–±—â–∞—è</div>
            </div>
            
            <div class="form-grid">
                <div class="row" id="timeFields">
                    <div class="col">
                        <label>–ù–∞—á–∞–ª–æ (In)</label>
                        <div class="time-input-group">
                            <!-- Added onblur and onkeydown -->
                            <input type="text" id="timeStart" placeholder="00:00:00" 
                                   onfocus="pauseVideo()" 
                                   onblur="formatInputTime(this)"
                                   onkeydown="handleInputEnter(event, 'timeEnd')">
                            <button class="time-capture-btn" onclick="captureTime('timeStart')">‚è±</button>
                        </div>
                    </div>
                    <div class="col">
                        <label>–ö–æ–Ω–µ—Ü (Out)</label>
                        <div class="time-input-group">
                            <input type="text" id="timeEnd" placeholder="00:00:00" 
                                   onfocus="pauseVideo()" 
                                   onblur="formatInputTime(this)"
                                   onkeydown="handleInputEnter(event, 'firstWords')">
                            <button class="time-capture-btn" onclick="captureTime('timeEnd')">‚è±</button>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="wordsFields">
                    <div class="col">
                        <label>–ù–∞—á–∞–ª–æ (—Å–ª–æ–≤–∞)</label>
                        <input type="text" id="firstWords" 
                               onkeydown="handleInputEnter(event, 'lastWords')">
                    </div>
                    <div class="col">
                        <label>–ö–æ–Ω–µ—Ü (—Å–ª–æ–≤–∞)</label>
                        <input type="text" id="lastWords" 
                               onkeydown="handleInputEnter(event, 'action')">
                    </div>
                </div>
                
                <div class="col">
                    <label id="actionLabel">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∫–∏</label>
                    <textarea id="action" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" onkeydown="handleEnter(event)" style="min-height: 60px;"></textarea>
                </div>
                
                <div class="row">
                    <button id="addBtn" class="btn btn-primary" style="flex: 1" onclick="addEdit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    <button id="cancelBtn" class="btn btn-secondary hidden" onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="panel-header">
            <div style="font-weight:600">–°–ø–∏—Å–æ–∫ (<span id="count">0</span>)</div>
            <button class="icon-btn danger" onclick="clearAll()">üóë</button>
        </div>
        <div class="edits-list" id="editsList">
            <div style="text-align:center; color:var(--text-muted); margin-top:40px;">–ù–µ—Ç –ø—Ä–∞–≤–æ–∫</div>
        </div>
        <div class="export-bar">
            <button class="btn btn-secondary" onclick="copyToClipboard()">üìã –¢–µ–∫—Å—Ç</button>
            <button class="btn btn-secondary" onclick="exportSRT()">üìÑ SRT</button>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let edits = [];
    let currentType = 'cut'; 
    let editingId = null;
    const player = document.getElementById('videoPlayer');
    const seekBar = document.getElementById('seekBar');
    const timeDisplay = document.getElementById('timeDisplay');
    const videoWrapper = document.getElementById('videoWrapper');
    const STORAGE_KEY = 'videoLogicPro_v9';

    document.addEventListener('DOMContentLoaded', () => {
        loadProject();
        setupVideoHandling();
        setupHotkeys();
    });

    // --- NEW: Smart Input Logic ---
    function formatInputTime(input) {
        let val = input.value.replace(/[^0-9]/g, ''); // Remove non-digits
        if (!val) return;

        // If user typed just numbers (e.g. 1234), format to HH:MM:SS
        // Pad start with zeros to ensure at least 6 digits (HHMMSS)
        val = val.padStart(6, '0');
        
        // Extract HH, MM, SS from the right
        const ss = val.slice(-2);
        const mm = val.slice(-4, -2);
        const hh = val.slice(0, -4);
        
        // Set formatted value
        input.value = `${hh.padStart(2,'0')}:${mm}:${ss}`;
    }

    function handleInputEnter(e, nextId) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // Format current field first
            if (e.target.id === 'timeStart' || e.target.id === 'timeEnd') {
                formatInputTime(e.target);
            }

            // Move focus
            const nextEl = document.getElementById(nextId);
            if (nextEl) nextEl.focus();
        }
    }

    // --- UI Logic ---
    function resizeVideo(val) { videoWrapper.style.height = val + 'vh'; }

    function setEditType(type) {
        currentType = type;
        document.getElementById('tab-cut').classList.toggle('active', type === 'cut');
        document.getElementById('tab-general').classList.toggle('active', type === 'general');
        
        const isGen = type === 'general';
        document.getElementById('timeFields').classList.toggle('hidden', isGen);
        document.getElementById('wordsFields').classList.toggle('hidden', isGen);
        document.getElementById('action').placeholder = isGen ? "–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –≤–∏–¥–µ–æ" : "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —ç—Ç–æ–º –º–æ–º–µ–Ω—Ç–µ?";
    }

    function togglePlay() { player.paused ? player.play() : player.pause(); }

    function setupVideoHandling() {
        player.addEventListener('click', togglePlay);
        player.addEventListener('timeupdate', () => {
            if (!player.duration) return;
            const percent = (player.currentTime / player.duration) * 100;
            seekBar.value = percent;
            timeDisplay.textContent = formatTimeSimple(player.currentTime) + " / " + formatTimeSimple(player.duration);
        });
        seekBar.addEventListener('input', () => {
            if (!player.duration) return;
            const time = (seekBar.value / 100) * player.duration;
            player.currentTime = time;
        });

        document.getElementById('videoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                player.src = URL.createObjectURL(file);
                player.classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('videoFooter').classList.remove('hidden');
                if(!document.getElementById('projectName').value) document.getElementById('projectName').value = file.name;
            }
        });
    }

    // --- Time Helpers ---
    function formatTimeSimple(seconds) {
        if (isNaN(seconds)) return "00:00";
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return "00:00:00";
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function parseTime(timeStr) {
        if (!timeStr) return 0;
        const parts = timeStr.split(':').map(Number);
        return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
    }

    function captureTime(fieldId) {
        if (!player.src) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ");
        document.getElementById(fieldId).value = formatTime(player.currentTime);
    }

    function changeSpeed(rate) { player.playbackRate = rate; }
    function pauseVideo() { player.pause(); }

    // --- CRUD ---
    function addEdit() {
        const action = document.getElementById('action').value.trim();
        if (!action) return alert("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");

        const editData = {
            id: editingId || Date.now(),
            type: currentType,
            action: action,
            timestamp: Date.now()
        };

        if (currentType === 'cut') {
            const start = document.getElementById('timeStart').value;
            const end = document.getElementById('timeEnd').value;
            
            if (!start) return alert("–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞");
            
            const startSec = parseTime(start);
            const endSec = parseTime(end);

            if (end && startSec >= endSec) {
                alert("–û—à–∏–±–∫–∞: –í—Ä–µ–º—è –ù–ê–ß–ê–õ–ê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –ö–û–ù–¶–ê!");
                return;
            }

            editData.timeStart = start;
            editData.timeEnd = end;
            editData.firstWords = document.getElementById('firstWords').value;
            editData.lastWords = document.getElementById('lastWords').value;
            editData.seconds = startSec;
        } else {
            editData.seconds = -1;
        }

        if (editingId) {
            const idx = edits.findIndex(e => e.id === editingId);
            edits[idx] = editData;
        } else {
            edits.push(editData);
        }

        edits.sort((a, b) => {
            if (a.type === 'general' && b.type !== 'general') return -1;
            if (a.type !== 'general' && b.type === 'general') return 1;
            return a.seconds - b.seconds;
        });

        saveProject();
        renderEdits();
        resetForm();
    }

    function editItem(id) {
        const item = edits.find(e => e.id === id);
        if (!item) return;
        setEditType(item.type);
        editingId = id;
        document.getElementById('action').value = item.action;
        if (item.type === 'cut') {
            document.getElementById('timeStart').value = item.timeStart;
            document.getElementById('timeEnd').value = item.timeEnd || '';
            document.getElementById('firstWords').value = item.firstWords || '';
            document.getElementById('lastWords').value = item.lastWords || '';
        }
        document.getElementById('addBtn').textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        document.getElementById('cancelBtn').classList.remove('hidden');
    }

    function deleteItem(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            edits = edits.filter(e => e.id !== id);
            if (editingId === id) resetForm();
            saveProject();
            renderEdits();
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('action').value = '';
        document.getElementById('timeStart').value = '';
        document.getElementById('timeEnd').value = '';
        document.getElementById('firstWords').value = '';
        document.getElementById('lastWords').value = '';
        document.getElementById('addBtn').textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å";
        document.getElementById('cancelBtn').classList.add('hidden');
        setEditType('cut');
    }

    function clearAll() {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ?")) {
            edits = [];
            saveProject();
            renderEdits();
        }
    }

    // --- Render ---
    function renderEdits() {
        const list = document.getElementById('editsList');
        document.getElementById('count').textContent = edits.length;
        if (edits.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-muted);margin-top:40px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
            return;
        }
        list.innerHTML = edits.map((item) => {
            const isGeneral = item.type === 'general';
            const contextStr = (item.firstWords || item.lastWords) ? 
                `<div class="card-context">${item.firstWords || ''} ... ${item.lastWords || ''}</div>` : '';
            
            const header = isGeneral ? `<span style="font-size:10px; font-weight:bold; color:#fcd34d; background:rgba(251,191,36,0.1); padding:2px 6px; border-radius:4px;">–û–ë–©–ê–Ø</span>` : 
                `<span class="timestamp-badge">‚è± ${item.timeStart}</span>` + (item.timeEnd ? `<span class="timestamp-badge" style="margin-left:4px">‚ûù ${item.timeEnd}</span>` : '');

            return `<div class="edit-card type-${item.type} ${item.id === editingId ? 'editing' : ''}" 
                     onclick="${!isGeneral ? `jumpTo('${item.timeStart}')` : ''}">
                    <div class="card-header">
                        <div>${header}</div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="icon-btn danger" onclick="event.stopPropagation(); deleteItem(${item.id})">üóë</button>
                        </div>
                    </div>
                    ${contextStr}
                    <div style="font-size:13px; line-height:1.4">${item.action}</div>
                </div>`;
        }).join('');
    }

    function jumpTo(time) { if(time) { player.currentTime = parseTime(time); player.play(); }}

    // --- Export ---
    function copyToClipboard() {
        const name = document.getElementById('projectName').value;
        let text = name ? `–ü–†–û–ï–ö–¢: ${name}\n\n` : '';
        edits.forEach((e, i) => {
            const prefix = e.type === 'general' ? '‚Ä¢ –û–ë–©–ê–Ø' : `${i+1}. ${e.timeStart}`;
            text += `${prefix}: ${e.action}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
    }

    function exportSRT() {
        let content = '', counter = 1;
        edits.forEach(e => {
            const start = e.type==='general' ? '00:00:00,000' : e.timeStart.replace('.', ',') + (e.timeStart.includes(',')?'':',000');
            const end = e.type==='general' ? '00:00:05,000' : (e.timeEnd ? e.timeEnd.replace('.', ',') : formatTime(parseTime(e.timeStart)+3).replace('.',',')+',000');
            content += `${counter++}\n${start} --> ${end}\n${e.action}\n\n`;
        });
        const blob = new Blob([content], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = (document.getElementById('projectName').value || 'edits') + '.srt';
        link.click();
    }

    // --- Hotkeys ---
    function setupHotkeys() {
        document.addEventListener('keydown', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
            if (e.code === 'Space') { e.preventDefault(); player.paused ? player.play() : player.pause(); }
            if (e.code === 'KeyI') { e.preventDefault(); captureTime('timeStart'); }
            if (e.code === 'KeyO') { e.preventDefault(); captureTime('timeEnd'); }
        });
    }
    function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addEdit(); } }

    function saveProject() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ name: document.getElementById('projectName').value, edits: edits })); }
    function loadProject() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (data) { document.getElementById('projectName').value = data.name || ''; edits = data.edits || []; renderEdits(); }
    }
    document.getElementById('projectName').addEventListener('input', saveProject);
</script>
</body>
</html>
