<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∞–≤–∫–∏ (Video Feedback Tool v3.8)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --bg-main: #0f172a;       
            --bg-secondary: #1e293b;  
            --bg-panel: #151e32;
            --bg-input: #334155;      
            --primary: #6366f1;       
            --primary-hover: #4f46e5;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --danger: #ef4444;
            --overlay-bg: rgba(15, 23, 42, 0.95);
            --radius: 6px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden;
            font-size: 13px;
        }

        .drag-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg); z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            border: 4px dashed var(--primary); backdrop-filter: blur(5px);
        }
        .drag-overlay.active { display: flex; }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 360px; 
            grid-template-rows: 50px 1fr;
            height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 10;
        }
        .brand { font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        .project-input {
            background: var(--bg-main); border: 1px solid var(--border);
            color: var(--text-main); padding: 6px 12px; border-radius: 4px; 
            width: 250px; font-size: 13px;
        }
        .project-input:focus { border-color: var(--primary); }

        .left-panel {
            background: var(--bg-main);
            display: flex; flex-direction: column;
            height: 100%; overflow: hidden;
            position: relative;
        }

        .video-wrapper {
            flex: 1; 
            background: #000;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .video-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #000; width: 100%; position: relative; overflow: hidden;
        }
        
        video { width: 100%; height: 100%; display: block; object-fit: contain; cursor: pointer; }

        .video-controls {
            background: var(--bg-secondary);
            padding: 10px 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            display: flex; flex-direction: column; gap: 8px;
        }

        .timeline-row { display: flex; align-items: center; gap: 10px; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; }
        .controls-left { display: flex; gap: 8px; align-items: center; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; height: 16px; display: block; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--bg-input); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 50%; background: var(--primary); margin-top: -4px; -webkit-appearance: none; transition: transform 0.1s; border: 2px solid #fff; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }

        .hotkeys-hint {
            font-size: 10px; color: var(--text-muted);
            background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px;
            display: flex; gap: 10px;
        }
        .hotkeys-hint span b { color: var(--text-main); }

        .upload-zone {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; color: var(--text-muted); z-index: 5; background: #0f172a;
        }
        .upload-btn {
            background: var(--primary); color: white; padding: 10px 20px; 
            border-radius: var(--radius); border: none; cursor: pointer; font-size: 14px;
            transition: 0.2s;
        }
        .upload-btn:hover { background: var(--primary-hover); }

        .editor-panel {
            background-color: var(--bg-panel);
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0; 
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }

        .tabs-row { display: flex; gap: 10px; margin-bottom: 4px; }
        .type-tab { 
            font-size: 11px; font-weight: 600; text-transform: uppercase; 
            padding: 4px 10px; border-radius: 4px; cursor: pointer; color: var(--text-muted); 
            border: 1px solid transparent; transition: 0.2s;
        }
        .type-tab.active { background: var(--bg-input); color: white; border-color: var(--border); }
        .type-tab:hover { color: white; }

        .inputs-row { display: grid; grid-template-columns: 0.8fr 0.8fr 1.2fr 1.2fr; gap: 8px; }
        
        .input-group { position: relative; }
        .input-group label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 3px; font-weight: 600; }
        
        input[type="text"], textarea {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 6px 8px; border-radius: 4px; font-size: 12px; font-family: 'JetBrains Mono', monospace;
            transition: border 0.2s;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); }
        
        .time-capture-btn {
            position: absolute; right: 2px; bottom: 2px; 
            width: 20px; height: 20px; border: none; border-radius: 3px; 
            background: transparent; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .time-capture-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        .action-row { display: flex; gap: 8px; align-items: stretch; height: 42px; }
        textarea { resize: none; font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.4; height: 100%; }
        
        .btn-add {
            background: var(--primary); color: white; border: none; 
            border-radius: 4px; padding: 0 20px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap;
        }
        .btn-add:hover { background: var(--primary-hover); }

        .btn-sm { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .btn-sm:hover { color: white; border-color: var(--text-muted); }

        .right-panel {
            background-color: var(--bg-secondary); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(30, 41, 59, 0.5); }
        .edits-list { flex: 1; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        .edit-card {
            background: var(--bg-main); border: 1px solid var(--border); 
            border-radius: 6px; padding: 10px; position: relative; cursor: pointer;
            border-left: 3px solid transparent; transition: 0.1s;
        }
        .edit-card:hover { transform: translateX(2px); border-color: var(--primary); }
        .edit-card.type-cut { border-left-color: var(--primary); }
        .edit-card.type-general { border-left-color: #f59e0b; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .timestamp-badge { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-family: monospace; }
        .card-context { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; font-style: italic; opacity: 0.8; }
        .card-actions { position: absolute; top: 8px; right: 8px; display: none; gap: 4px; }
        .edit-card:hover .card-actions { display: flex; }
        
        .icon-btn { width: 20px; height: 20px; border-radius: 3px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .icon-btn:hover { color: white; }
        .icon-btn.danger:hover { background: var(--danger); border-color: var(--danger); }
        
        .export-bar { padding: 10px; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; gap: 6px; }
        .export-bar button { flex: 1; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="dragOverlay" class="drag-overlay">
    <div style="font-size: 64px;">üìÇ</div>
    <div style="color: white; margin-top: 10px;">–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –∑–¥–µ—Å—å</div>
</div>

<div class="app-container">
    <header class="header">
        <div class="brand">üìù –ü—Ä–∞–≤–∫–∏</div>
        <input type="text" id="projectName" class="project-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
    </header>

    <div class="left-panel">
        <div class="video-wrapper">
            <div class="video-container">
                <video id="videoPlayer" class="hidden"></video>
                <div id="uploadPlaceholder" class="upload-zone">
                    <div style="font-size: 40px; opacity: 0.5">üìÇ</div>
                    <button class="upload-btn" onclick="document.getElementById('videoUpload').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
                    <div style="font-size: 11px; opacity: 0.5">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</div>
                    <input type="file" id="videoUpload" accept="video/*" style="display:none" onchange="handleFileSelect(this.files)">
                </div>
            </div>
            
            <div class="video-controls hidden" id="videoControls">
                <div class="timeline-row">
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1" onchange="this.blur()">
                    <div id="timeDisplay" style="font-family: monospace; font-size: 11px; min-width: 90px; text-align: right; color: #94a3b8;">00:00 / 00:00</div>
                </div>
                <div class="controls-row">
                    <div class="controls-left">
                        <button class="btn-sm" onclick="togglePlay()">‚èØ Play</button>
                        <button class="btn-sm" onclick="changeSpeed(1)">1x</button>
                        <button class="btn-sm" onclick="changeSpeed(1.5)">1.5x</button>
                        <button class="btn-sm" onclick="changeSpeed(2)">2x</button>
                    </div>
                    <div class="hotkeys-hint">
                        <span><b>Space</b> Play</span>
                        <span><b>‚Üê ‚Üí</b> Seek</span>
                        <span><b>I/O</b> In/Out</span>
                        <span><b>Enter</b> Add</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-panel">
            <div class="tabs-row">
                <div class="type-tab active" id="tab-cut" onclick="setEditType('cut')">–ü–æ —Ç–∞–π–º–∫–æ–¥—É</div>
                <div class="type-tab" id="tab-general" onclick="setEditType('general')">–û–±—â–∞—è –ø—Ä–∞–≤–∫–∞</div>
            </div>
            
            <div id="inputsSection" class="inputs-row">
                <div class="input-group">
                    <label>–ù–∞—á–∞–ª–æ (IN)</label>
                    <input type="text" id="timeStart" placeholder="00:00:00" onblur="validateTimeInput(this)" onkeydown="handleInputEnter(event, 'timeEnd')">
                    <button class="time-capture-btn" onclick="captureTime('timeStart')" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è">‚è±</button>
                </div>
                <div class="input-group">
                    <label>–ö–æ–Ω–µ—Ü (OUT)</label>
                    <input type="text" id="timeEnd" placeholder="00:00:00" onblur="validateTimeInput(this)" onkeydown="handleInputEnter(event, 'firstWords')">
                    <button class="time-capture-btn" onclick="captureTime('timeEnd')" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è">‚è±</button>
                </div>
                <div class="input-group">
                    <label>–ù–∞—á–∞–ª–æ (—Å–ª–æ–≤–∞)</label>
                    <input type="text" id="firstWords" placeholder="..." onkeydown="handleInputEnter(event, 'lastWords')" style="font-family: 'Inter', sans-serif;">
                </div>
                <div class="input-group">
                    <label>–ö–æ–Ω–µ—Ü (—Å–ª–æ–≤–∞)</label>
                    <input type="text" id="lastWords" placeholder="..." onkeydown="handleInputEnter(event, 'action')" style="font-family: 'Inter', sans-serif;">
                </div>
            </div>

            <div class="action-row">
                <textarea id="action" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..." style="flex:1" onkeydown="handleEnter(event)"></textarea>
                <button id="addBtn" class="btn-add" onclick="addEdit()">
                    <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button id="cancelBtn" class="btn-sm hidden" onclick="resetForm()">‚ùå</button>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="panel-header">
            <div style="font-weight:600; font-size: 12px;">–°–ø–∏—Å–æ–∫ (<span id="count">0</span>)</div>
            <button class="icon-btn danger" onclick="clearAll()">üóë</button>
        </div>
        <div class="edits-list" id="editsList">
            <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-size:12px;">–ù–µ—Ç –ø—Ä–∞–≤–æ–∫</div>
        </div>
        <div class="export-bar">
            <button class="btn-sm" onclick="copyToClipboard()">üìã –¢–µ–∫—Å—Ç</button>
            <button class="btn-sm" onclick="exportSRT()">üìÑ SRT</button>
        </div>
    </div>
</div>

<script>
    let edits = [];
    let currentType = 'cut'; 
    let editingId = null;
    const player = document.getElementById('videoPlayer');
    const seekBar = document.getElementById('seekBar');
    const timeDisplay = document.getElementById('timeDisplay');
    const dragOverlay = document.getElementById('dragOverlay');
    const STORAGE_KEY = 'videoLogicPro_v18';

    document.addEventListener('DOMContentLoaded', () => {
        loadProject();
        setupVideoHandling();
        setupHotkeys();
        setupDragAndDrop();
    });

    function handleFileSelect(files) { if (files.length > 0) loadVideoFile(files[0]); }

    function loadVideoFile(file) {
        if (!file.type.startsWith('video/')) return alert("–≠—Ç–æ –Ω–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª!");
        player.src = URL.createObjectURL(file);
        player.classList.remove('hidden');
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('videoControls').classList.remove('hidden');
        if(!document.getElementById('projectName').value) document.getElementById('projectName').value = file.name;
    }

    function validateTimeInput(input) {
        let val = input.value.replace(/[^0-9]/g, ''); 
        if (!val) return;
        val = val.padStart(6, '0');
        let hh = parseInt(val.slice(0, -4));
        let mm = parseInt(val.slice(-4, -2));
        let ss = parseInt(val.slice(-2));
        if (ss > 59) ss = 59;
        if (mm > 59) mm = 59;
        input.value = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
    }

    function handleInputEnter(e, nextId) {
        if (e.key === 'Enter') {
            e.preventDefault();
            validateTimeInput(e.target);
            const nextEl = document.getElementById(nextId);
            if (nextEl) nextEl.focus();
        }
    }

    function setupDragAndDrop() {
        const body = document.body;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => body.addEventListener(n, e => { e.preventDefault(); e.stopPropagation(); }));
        body.addEventListener('dragenter', () => dragOverlay.classList.add('active'));
        dragOverlay.addEventListener('dragleave', (e) => { if(e.target === dragOverlay) dragOverlay.classList.remove('active'); });
        body.addEventListener('drop', (e) => {
            dragOverlay.classList.remove('active');
            handleFileSelect(e.dataTransfer.files);
        });
    }

    function togglePlay() { player.paused ? player.play() : player.pause(); }
    function seek(sec) { if(player.src) player.currentTime = Math.min(Math.max(player.currentTime + sec, 0), player.duration); }
    function changeSpeed(rate) { player.playbackRate = rate; }

    function setupVideoHandling() {
        player.addEventListener('click', togglePlay);
        player.addEventListener('timeupdate', () => {
            if (!player.duration) return;
            seekBar.value = (player.currentTime / player.duration) * 100;
            timeDisplay.textContent = formatTimeFull(player.currentTime) + " / " + formatTimeFull(player.duration);
        });
        seekBar.addEventListener('input', () => {
            if (player.duration) player.currentTime = (seekBar.value / 100) * player.duration;
        });
        seekBar.addEventListener('mouseup', () => seekBar.blur());
    }

    function formatTimeFull(seconds) {
        if (isNaN(seconds)) return "00:00:00";
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    // NEW: Adaptive formatting for Copy to Clipboard (removes 00 hours if unused)
    function formatAdaptiveTime(seconds) {
        if (isNaN(seconds)) return "00:00";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        const mStr = m.toString().padStart(2, '0');
        const sStr = s.toString().padStart(2, '0');
        if (h > 0) {
            return `${h.toString().padStart(2, '0')}:${mStr}:${sStr}`;
        }
        return `${mStr}:${sStr}`;
    }

    function parseTime(str) {
        if (!str) return 0;
        const p = str.split(':').map(Number);
        return (p[0] * 3600) + (p[1] * 60) + p[2];
    }

    function captureTime(id) {
        if (!player.src) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ");
        document.getElementById(id).value = formatTimeFull(player.currentTime);
    }

    function setEditType(type) {
        currentType = type;
        document.getElementById('tab-cut').classList.toggle('active', type === 'cut');
        document.getElementById('tab-general').classList.toggle('active', type === 'general');
        const inputs = document.getElementById('inputsSection');
        if (type === 'general') {
            inputs.style.display = 'none';
            document.getElementById('action').placeholder = "–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –≤–∏–¥–µ–æ...";
        } else {
            inputs.style.display = 'grid';
            document.getElementById('action').placeholder = "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?";
        }
    }

    function addEdit() {
        const action = document.getElementById('action').value.trim();
        if (!action) return alert("–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å");

        const editData = { id: editingId || Date.now(), type: currentType, action, timestamp: Date.now() };

        if (currentType === 'cut') {
            const start = document.getElementById('timeStart').value;
            const end = document.getElementById('timeEnd').value;
            if (!start) return alert("–ù—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞");
            const sSec = parseTime(start);
            const eSec = parseTime(end);
            if (end && sSec >= eSec) return alert("–û—à–∏–±–∫–∞: –ù–∞—á–∞–ª–æ –ø–æ–∑–∂–µ –ö–æ–Ω—Ü–∞");

            editData.timeStart = start;
            editData.timeEnd = end;
            editData.firstWords = document.getElementById('firstWords').value;
            editData.lastWords = document.getElementById('lastWords').value;
            editData.seconds = sSec;
        } else {
            editData.seconds = -1;
        }

        if (editingId) {
            edits[edits.findIndex(e => e.id === editingId)] = editData;
        } else {
            edits.push(editData);
        }

        edits.sort((a,b) => (a.type === 'general' && b.type !== 'general') ? -1 : (a.seconds - b.seconds));
        saveProject();
        renderEdits();
        resetForm();
    }

    function editItem(id) {
        const item = edits.find(e => e.id === id);
        if(!item) return;
        setEditType(item.type);
        editingId = id;
        document.getElementById('action').value = item.action;
        if(item.type === 'cut') {
            document.getElementById('timeStart').value = item.timeStart;
            document.getElementById('timeEnd').value = item.timeEnd || '';
            document.getElementById('firstWords').value = item.firstWords || '';
            document.getElementById('lastWords').value = item.lastWords || '';
        }
        document.getElementById('addBtn').innerHTML = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        document.getElementById('cancelBtn').classList.remove('hidden');
    }

    function deleteItem(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            edits = edits.filter(e => e.id !== id);
            if(editingId === id) resetForm();
            saveProject();
            renderEdits();
        }
    }

    function resetForm() {
        editingId = null;
        document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
        document.getElementById('addBtn').innerHTML = "<span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å";
        document.getElementById('cancelBtn').classList.add('hidden');
        setEditType('cut');
    }

    function clearAll() {
        if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ?")) { edits = []; saveProject(); renderEdits(); }
    }

    function renderEdits() {
        const list = document.getElementById('editsList');
        document.getElementById('count').textContent = edits.length;
        if (!edits.length) { list.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:40px; font-size:12px;">–ù–µ—Ç –ø—Ä–∞–≤–æ–∫</div>'; return; }
        
        list.innerHTML = edits.map(e => {
            const isGen = e.type === 'general';
            const badge = isGen ? `<span class="timestamp-badge" style="color:#fcd34d; background:rgba(251,191,36,0.1)">–û–ë–©–ê–Ø</span>` 
                                : `<span class="timestamp-badge">${e.timeStart}</span>` + (e.timeEnd ? `<span class="timestamp-badge" style="margin-left:4px">‚ûù ${e.timeEnd}</span>` : '');
            const ctx = (e.firstWords || e.lastWords) ? `<div class="card-context">${e.firstWords || ''} ... ${e.lastWords || ''}</div>` : '';
            
            return `<div class="edit-card type-${e.type}" onclick="${!isGen ? `player.currentTime=${e.seconds};player.play()` : ''}">
                <div class="card-header"><div>${badge}</div></div>
                ${ctx}
                <div style="font-size:13px; line-height:1.4">${e.action}</div>
                <div class="card-actions">
                    <button class="icon-btn" onclick="event.stopPropagation(); editItem(${e.id})">‚úèÔ∏è</button>
                    <button class="icon-btn danger" onclick="event.stopPropagation(); deleteItem(${e.id})">üóë</button>
                </div>
            </div>`;
        }).join('');
    }

    function setupHotkeys() {
        document.addEventListener('keydown', e => {
            const tag = document.activeElement.tagName;
            const isTyping = (tag === 'INPUT' && document.activeElement.type !== 'range' && document.activeElement.type !== 'file') || tag === 'TEXTAREA';
            
            if(e.code === 'Space' && !isTyping) { e.preventDefault(); togglePlay(); }
            if(e.code === 'ArrowLeft' && !isTyping) { e.preventDefault(); seek(-5); }
            if(e.code === 'ArrowRight' && !isTyping) { e.preventDefault(); seek(5); }
            if(!isTyping) {
                if(e.code === 'KeyI') { e.preventDefault(); captureTime('timeStart'); }
                if(e.code === 'KeyO') { e.preventDefault(); captureTime('timeEnd'); }
            }
        });
    }

    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addEdit(); } }

    // --- Export (Updated with Adaptive Time) ---
    function copyToClipboard() {
        let txt = document.getElementById('projectName').value + '\n\n';
        const generals = edits.filter(e => e.type === 'general');
        const cuts = edits.filter(e => e.type === 'cut');

        if (generals.length > 0) {
            txt += "=== –û–ë–©–ò–ï ===\n";
            generals.forEach((e, i) => txt += `${i+1}. ${e.action}\n`);
            txt += "\n";
        }

        if (cuts.length > 0) {
            txt += "=== –ü–û –¢–ê–ô–ú–ö–û–î–£ ===\n";
            cuts.forEach((e, i) => {
                // Use formatAdaptiveTime for clipboard copy
                const startAdaptive = formatAdaptiveTime(e.seconds);
                let endAdaptive = '';
                if (e.timeEnd) {
                    const endSec = parseTime(e.timeEnd);
                    endAdaptive = `-${formatAdaptiveTime(endSec)}`;
                }
                
                const words = (e.firstWords || e.lastWords) ? ` [${e.firstWords || ''}...${e.lastWords || ''}]` : '';
                txt += `${i+1}. ${startAdaptive}${endAdaptive}${words}: ${e.action}\n`;
            });
        }
        
        navigator.clipboard.writeText(txt).then(() => alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
    }

    function exportSRT() {
        let c = '', n = 1;
        
        // Separate sorting for SRT validity: General first (0-4, 4-8), then Timecode edits
        const generals = edits.filter(e => e.type === 'general');
        const cuts = edits.filter(e => e.type === 'cut');

        generals.forEach((g, i) => {
            let startSec = i * 4;
            let endSec = startSec + 4;
            let s = formatTimeFull(startSec).replace('.', ',') + ',000';
            let e = formatTimeFull(endSec).replace('.', ',') + ',000';
            c += `${n++}\n${s} --> ${e}\n[–û–ë–©–ê–Ø –ü–†–ê–í–ö–ê #${i+1}]\n${g.action}\n\n`;
        });

        cuts.forEach(e => {
            let s = e.timeStart.replace('.',',') + (e.timeStart.includes(',') ? '' : ',000');
            let endStr = e.timeEnd ? e.timeEnd.replace('.',',') + (e.timeEnd.includes(',') ? '' : ',000') 
                                   : formatTimeFull(e.seconds + 3).replace('.',',') + ',000';

            let contextLine = '';
            if (e.firstWords || e.lastWords) {
                const f = e.firstWords || '';
                const l = e.lastWords || '';
                const sep = (f && l) ? ' ... ' : '';
                contextLine = `[${f}${sep}${l}]\n`;
            }

            c += `${n++}\n${s} --> ${endStr}\n${contextLine}${e.action}\n\n`;
        });
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([c],{type:'text/plain'}));
        a.download = (document.getElementById('projectName').value||'edits')+'.srt';
        a.click();
    }

    function saveProject() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ name: document.getElementById('projectName').value, edits })); }
    function loadProject() {
        const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if(d) { document.getElementById('projectName').value = d.name || ''; edits = d.edits || []; renderEdits(); }
    }
    document.getElementById('projectName').addEventListener('input', saveProject);
</script>
</body>
</html>
